clc
close all
clear

lw = 1.25;

i_ni_target = 0.42e-15;     % 0.42 fA/sqrt(Hz)

C_PD = 140e-12;
R_PD = 5e9;

C_IN = C_PD;    % Ignoring opamp Cin for now because PD is so big

R_F_vec = logspace( 0, 15, 1000 );    % Picking arb value for TIA gain for now

GBWP = 4.2e6;     % Opamp gain-BW product (took LT1792 as typical example)

C_F_vec = sqrt( C_IN ./ ( 2 * pi * GBWP * R_F_vec ) );

%disp( [ 'C_F = ' num2str( C_F * 1e12 ) ' pF' ] );

f_3dB_TIA_vec = sqrt( GBWP ./ ( 2 * pi * R_F_vec * C_IN ) );

%disp( [ 'f_3dB_TIA = ' num2str( f_3dB_TIA * 1e-3 ) ' kHz' ] );

i_n_opamp = 0.1e-15;    % 0.1 fA/sqrt(Hz)
e_n_opamp = 1.0e-10;	% 0.1 nV/sqrt(Hz)
k_B = physconst( 'Boltzmann' );
T = 300;

i_ni_opamp_i_term = i_n_opamp * ones( size( R_F_vec ) );
i_ni_opamp_e_term = sqrt( e_n_opamp^2 ./ R_F_vec );
i_ni_R_F_term = sqrt( 4 * k_B * T ./ R_F_vec );
i_ni_peaking_term = sqrt( ( e_n_opamp * 2 * pi * f_3dB_TIA_vec * C_IN ).^2 / 3 );

i_ni_vec = sqrt( i_n_opamp^2 + e_n_opamp^2 ./ R_F_vec + 4 * k_B * T ./ R_F_vec + ( e_n_opamp * 2 * pi * f_3dB_TIA_vec * C_IN ).^2 / 3 );

%disp( [ 'Input-referred noise = ' num2str( i_ni * 1e15 ) ' fA/sqrt(Hz)' ] );

fig1 = figure( ); hold all; grid on;

plot( R_F_vec, 1e15 * i_ni_vec, 'linewidth', lw );

plot( R_F_vec, 1e15 * i_ni_opamp_i_term, '--', 'linewidth', lw );
plot( R_F_vec, 1e15 * i_ni_opamp_e_term, '--', 'linewidth', lw );
plot( R_F_vec, 1e15 * i_ni_R_F_term, '--', 'linewidth', lw );
plot( R_F_vec, 1e15 * i_ni_peaking_term, '--', 'linewidth', lw );

plot( R_F_vec, 1e15 * i_ni_target * ones( size( R_F_vec ) ), 'k', 'linewidth', lw );

legend( 'Total', 'Opamp Current Noise', 'Opamp Voltage Noise', 'R_F Noise', 'C_{IN} Peaking Effect', 'Target' );

set( gca, 'xscale', 'log' );
set( gca, 'yscale', 'log' );

xlabel( 'R_F' );
ylabel( 'Input-Referred Noise [fA/sqrt(Hz)]' );